# Cluster-Lifecycle steuern

Das Management von Kubernetes-Clustern √ºber ihren gesamten Lebenszyklus ist ein Kernbereich der Cluster API. Du lernst hier, wie du Cluster skalierst, aktualisierst und reparierst ‚Äì alles deklarativ √ºber YAML.

## üîÑ Der Reconcile Loop verstehen

Die Cluster API arbeitet nach dem Controller-Pattern. Jeder Controller √ºberwacht "seine" Ressourcen und gleicht kontinuierlich den gew√ºnschten Zustand mit der Realit√§t ab.

**Beispiel**: Du √§nderst `spec.replicas` von 2 auf 4 Worker-Nodes:

1. Controller erkennt die Differenz (2 vs. 4)
2. Controller erstellt 2 neue `Machine`-Ressourcen
3. Infrastructure Provider startet 2 neue VMs/Container
4. Bootstrap Provider konfiguriert die neuen Nodes
5. Neue Nodes joinen das Cluster

Dieser Prozess l√§uft automatisch ‚Äì du musst nur den gew√ºnschten Zustand definieren.

## üìà Cluster skalieren

### Worker-Nodes hinzuf√ºgen

Skaliere das Cluster mit clusterctl:

```bash
# Worker-Nodes auf 3 erh√∂hen
clusterctl alpha rollout restart machinedeployment/my-cluster-md-0
# Oder direktes Scaling √ºber kubectl
kubectl scale machinedeployment my-cluster-md-0 --replicas=3
```

Status verfolgen:

```bash
clusterctl describe cluster my-cluster
kubectl get machines
```

### Control-Plane skalieren

F√ºr hochverf√ºgbare Cluster skalierst du die Control-Plane:

```bash
kubectl scale kubeadmcontrolplane my-cluster-control-plane --replicas=3
```

**Wichtig**: Control-Plane-Nodes sollten immer in ungerader Anzahl laufen (1, 3, 5) wegen etcd-Quorum.

## ‚¨ÜÔ∏è Kubernetes-Version upgraden

### Control-Plane upgraden

```bash
# Kubernetes-Version auf v1.31.2 upgraden
clusterctl alpha rollout restart kubeadmcontrolplane/my-cluster-control-plane
```

Der Controller f√ºhrt das Upgrade automatisch durch:

- Erstellt neue Control-Plane-Node mit neuer Version
- Migriert etcd-Daten
- Entfernt alte Control-Plane-Node
- Wiederholt den Prozess f√ºr alle Control-Plane-Nodes

### Worker-Nodes upgraden

```bash
# Worker-Nodes upgraden
clusterctl alpha rollout restart machinedeployment/my-cluster-md-0
```

**Rolling Updates**: Worker-Nodes werden schrittweise ersetzt, um die Verf√ºgbarkeit zu gew√§hrleisten.

## üîç Status und Debugging

### Cluster-Status pr√ºfen

```bash
# √úberblick √ºber alle Cluster
clusterctl describe cluster

# Details zu einem bestimmten Cluster
clusterctl describe cluster my-cluster

# Machine-Status
kubectl get machines -o wide
```

### Controller-Logs lesen

Bei Problemen helfen die Controller-Logs:

```bash
# Core Cluster API Controller
kubectl logs -n capi-system deployment/capi-controller-manager -f

# Control-Plane Controller
kubectl logs -n capi-kubeadm-control-plane-system \
  deployment/capi-kubeadm-control-plane-controller-manager -f

# Infrastructure Provider (CAPD)
kubectl logs -n capd-system deployment/capd-controller-manager -f
```

## üö® Probleme beheben

### H√§ngende Machines

Manchmal bleiben Machines in `Provisioning` oder `Failed` h√§ngen:

```bash
# Machine-Details anschauen
kubectl describe machine <machine-name>

# Zugeh√∂rige DockerMachine pr√ºfen
kubectl describe dockermachine <dockermachine-name>

# Bei Bedarf Machine l√∂schen (wird neu erstellt)
kubectl delete machine <machine-name>
```

### Control-Plane-Probleme

```bash
# Control-Plane-Status pr√ºfen
kubectl describe kubeadmcontrolplane my-cluster-control-plane

# etcd-Status im Workload-Cluster pr√ºfen
kubectl --kubeconfig=kubeconfig-workload get pods -n kube-system
```

### Node-Probleme im Workload-Cluster

```bash
# Nodes im Workload-Cluster pr√ºfen
kubectl --kubeconfig=kubeconfig-workload get nodes

# Node-Details anschauen
kubectl --kubeconfig=kubeconfig-workload describe node <node-name>
```

## üîß Maintenance-Modi

### Cluster zwischen Management-Clustern verschieben

Mit `clusterctl move` verschiebst du Cluster zwischen verschiedenen Management-Clustern:

```bash
# Aktuelles Management-Cluster (Quelle)
kubectl config use-context source-mgmt-cluster

# Ziel-Management-Cluster vorbereiten
kubectl config use-context target-mgmt-cluster
clusterctl init --infrastructure docker

# Zur√ºck zur Quelle wechseln
kubectl config use-context source-mgmt-cluster

# Cluster verschieben
clusterctl move --to-kubeconfig ~/.kube/target-mgmt-config

# Oder spezifisches Cluster verschieben
clusterctl move --to-kubeconfig ~/.kube/target-mgmt-config \
  --filter cluster=my-cluster
```

**Pivot-Prozess**: Der Pivot-Prozess verschiebt Provider-Komponenten und Cluster API Ressourcen von einem Quell-Management-Cluster zu einem Ziel-Management-Cluster.

### Machine-Health-Checks

Cluster API kann unhealthy Nodes automatisch ersetzen:

```yaml
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineHealthCheck
metadata:
  name: my-cluster-worker-health-check
spec:
  clusterName: my-cluster
  selector:
    matchLabels:
      cluster.x-k8s.io/deployment-name: my-cluster-md-0
  unhealthyConditions:
    - type: Ready
      status: Unknown
      timeout: 300s
    - type: Ready
      status: "False"
      timeout: 300s
  maxUnhealthy: 40%
  nodeStartupTimeout: 10m
```
